<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerador de Provas • MSY</title>
<style>
*{ box-sizing:border-box; margin:0; padding:0; }
body{
  font-family: "Segoe UI", system-ui, sans-serif;
  background: radial-gradient(circle at top,#1a0000,#0f0000,#000000);
  color:#fff;
  min-height:100vh;
  padding:40px 20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  animation:fadeIn 1s ease-out;
  overflow-x:hidden;
}
@keyframes fadeIn{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}
h1{
  font-size:36px;
  font-weight:800;
  letter-spacing:0.05em;
  text-transform:uppercase;
  background:linear-gradient(90deg,#ff4545,#b30000,#600000);
  -webkit-background-clip:text;
  color:transparent;
  text-shadow:0 0 20px rgba(255,0,0,0.5);
  animation:titleGlow 4s ease-in-out infinite;
}
@keyframes titleGlow{
  0%,100%{text-shadow:0 0 20px rgba(255,0,0,0.5);}
  50%{text-shadow:0 0 35px rgba(255,0,0,0.9);}
}
.sub{
  margin-top:6px;
  font-size:15px;
  opacity:0.8;
  letter-spacing:0.02em;
}
.card{
  width:100%;
  max-width:950px;
  background:rgba(20,0,0,0.4);
  border:1px solid rgba(255,0,0,0.25);
  border-radius:20px;
  padding:28px;
  margin-top:25px;
  backdrop-filter:blur(14px);
  box-shadow: 0 0 25px rgba(255,0,0,0.18), inset 0 0 25px rgba(255,0,0,0.15);
  position:relative;
  animation:cardIn 1.2s ease-out;
}
@keyframes cardIn{
  from{opacity:0; transform:translateY(25px);}
  to{opacity:1; transform:translateY(0);}
}
.card::before{
  content:"";
  position:absolute;
  top:-40%;
  right:-30%;
  width:290px;
  height:290px;
  background:radial-gradient(circle,rgba(255,0,0,0.4),transparent 70%);
  filter:blur(40px);
  animation:pulse 5s infinite ease-in-out;
}
@keyframes pulse{
  0%,100%{opacity:0.4;}
  50%{opacity:0.7;}
}
.row{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:18px;
}
.full{ grid-column:1 / -1; }
.field label,
label{
  font-size:14px;
  font-weight:600;
  margin-bottom:4px;
  color:#ffb3b3;
}
input, select{
  width:100%;
  padding:11px 12px;
  border-radius:8px;
  border:1px solid rgba(255,0,0,0.35);
  background:rgba(0,0,0,0.4);
  color:#fff;
  transition:0.2s;
}
input:hover, select:hover{ border-color:#ff4d4d; }
input:focus, select:focus{
  outline:none;
  border-color:#ff1a1a;
  box-shadow:0 0 12px rgba(255,0,0,0.4);
  transform:translateY(-1px);
}
input[type="file"]{ padding:8px; }
.chk{
  display:flex;
  align-items:flex-start;
  gap:8px;
}
.chk input{ width:auto; }
button{
  margin-top:25px;
  width:100%;
  padding:14px;
  font-size:17px;
  font-weight:700;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,#ff1a1a,#9b0000);
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 18px rgba(255,0,0,0.35);
  transition:0.15s;
  letter-spacing:0.5px;
  text-transform:uppercase;
}
button:hover{
  filter:brightness(1.1);
  transform:translateY(-2px);
  box-shadow:0 0 25px rgba(255,0,0,0.6);
}
button:active{ transform:scale(0.98); }
.is-loading{
  opacity:0.8;
  pointer-events:none;
}
.btn-loader{
  width:17px;
  height:17px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,0.35);
  border-top-color:#fff;
  animation:spin 0.7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
#resultado{
  margin-top:22px;
  font-size:15px;
  background:rgba(255,40,40,0.08);
  border:1px solid rgba(255,0,0,0.3);
  padding:12px 14px;
  border-radius:10px;
  box-shadow:inset 0 0 15px rgba(255,0,0,0.12);
}
.loading-dots span{
  display:inline-block;
  width:5px;
  height:5px;
  margin:0 1px;
  background:#ff3333;
  border-radius:50%;
  animation:bounce 0.8s infinite alternate;
}
.loading-dots span:nth-child(2){animation-delay:0.2s;}
.loading-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes bounce{
  to{transform:translateY(-3px); opacity:0.6;}
}
iframe{
  width:100%;
  min-height:600px;
  margin-top:12px;
  border-radius:14px;
  border:1px solid rgba(255,0,0,0.25);
  background:#000;
  box-shadow:0 0 20px rgba(255,0,0,0.2);
}
.download-actions{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.download-actions button{
  width:auto;
  padding:10px 18px;
  font-size:14px;
  margin-top:0;
}
@media(max-width:720px){
  .row{grid-template-columns:1fr;}
  body{padding:20px 15px;}
}
.help-text{
  font-size:12px;
  color:#ffcccc;
  margin-top:2px;
  opacity:0.85;
}
/* deixar #prova-html pequeno e fora da vista, mas não display:none */
#prova-html{
  position:absolute;
  left:-9999px;
  top:-9999px;
  width:800px;
  background:#fff;
  color:#000;
}
</style>
</head>
<body>
<h1>Gerador de Provas MSY</h1>
<p class="sub">Ferramenta oficial da Ordem. Precisão, rapidez e padrão profissional.</p>

<div class="card">
  <div class="row">

    <!-- ESCOLHA DE IA -->
    <div class="full">
      <label for="ia">Inteligência Artificial (motor de geração da prova)</label>
      <select id="ia">
        <option value="perplexity">
          Perplexity (Sonar) – ideal para provas bem contextualizadas, estilo ENEM e ensino médio.
        </option>
        <option value="llama" selected>
          LLaMA – indicado para provas gerais e rascunhos rápidos.
        </option>
        <option value="deepseek">
          DeepSeek – recomendado para provas técnicas, informática, matemática e exatas.
        </option>
      </select>
    </div>

    <div class="full">
      <label>Curso</label>
      <input type="text" id="curso" value="Windows">
    </div>

    <div class="full">
      <label>Título da Prova</label>
      <input type="text" id="titulo_prova">
    </div>

    <div>
      <label>Pontos por questão</label>
      <input type="number" id="pontos" value="5">
    </div>

    <div>
      <label>Quantidade de questões</label>
      <input type="number" id="quantidade" value="10">
    </div>

    <div>
      <label>Matéria</label>
      <input type="text" id="materia" value="Informática">
    </div>

    <div>
      <label>Assunto</label>
      <input type="text" id="assunto" value="Windows 11 – arquivos e atalhos">
    </div>

    <div>
      <label>Nível principal</label>
      <select id="nivel">
        <option value="facil">Fácil</option>
        <option value="medio" selected>Médio</option>
        <option value="dificil">Difícil</option>
      </select>
    </div>

    <div>
      <label>Tipo</label>
      <select id="tipo">
        <option value="multipla_escolha">Múltipla Escolha</option>
        <option value="verdadeiro_falso">Verdadeiro ou Falso</option>
        <option value="dissertativa">Dissertativa</option>
      </select>
    </div>

    <div>
      <label>Estilo</label>
      <select id="estilo">
        <option value="escolar">Escolar</option>
        <option value="concurso_publico">Concurso Público</option>
        <option value="vestibular">ENEM</option>
      </select>
    </div>

    <div>
      <label>Público</label>
      <input type="text" id="publico" value="Ensino médio">
    </div>

    <div class="full">
      <label>Distribuição por nível (%)</label>
      <input type="text" id="dist_niveis" value="40/40/20">
      <div class="help-text">
        Exemplo: 40/40/20 = 40% questões fáceis, 40% médias e 20% difíceis.
      </div>
    </div>

    <div class="full">
      <label>Apostila (opcional)</label>
      <input type="file" id="apostila">
    </div>

    <div class="full chk">
      <input type="checkbox" id="usar_apostila">
      <label>Usar conteúdo da apostila</label>
    </div>

    <div class="full chk">
      <input type="checkbox" id="gabarito" checked>
      <label>Incluir gabarito com explicações</label>
    </div>

  </div>

  <button onclick="gerar()">Gerar Prova</button>

  <div id="resultado"></div>

  <!-- Área da prova + botões de download -->
  <div id="prova-container" style="margin-top:16px; display:none;">
    <div class="download-actions">
      <button type="button" onclick="baixarPDF()">Baixar em PDF</button>
      <button type="button" onclick="baixarWord()">Baixar em Word</button>
    </div>
    <iframe id="preview"></iframe>
    <!-- Conteúdo da prova em HTML puro para exportação -->
    <div id="prova-html"></div>
  </div>
</div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Word -->
<script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.1.0/dist/html-docx.min.js"></script>

<script>
async function gerar(){
  const botao = document.querySelector("button");
  const resultado = document.getElementById("resultado");
  const iframe = document.getElementById("preview");
  const provaContainer = document.getElementById("prova-container");
  const provaHtmlDiv = document.getElementById("prova-html");

  botao.classList.add("is-loading");
  const textoOriginal = botao.innerHTML;
  botao.innerHTML = '<div class="btn-loader"></div> Processando...';

  resultado.innerHTML =
    '<div class="loading-text">Preparando prova ' +
    '<div class="loading-dots"><span></span><span></span><span></span></div>' +
    '</div>';
  iframe.style.display = "none";
  provaContainer.style.display = "none";
  provaHtmlDiv.innerHTML = "";

  const payload = {
    curso: document.getElementById("curso").value.trim(),
    titulo_prova: document.getElementById("titulo_prova").value.trim(),
    pontos_por_questao: parseInt(document.getElementById("pontos").value),
    materia: document.getElementById("materia").value.trim(),
    assunto: document.getElementById("assunto").value.trim(),
    quantidade: parseInt(document.getElementById("quantidade").value),
    nivel: document.getElementById("nivel").value,
    tipo: document.getElementById("tipo").value,
    estilo: document.getElementById("estilo").value,
    publico: document.getElementById("publico").value.trim(),
    incluir_gabarito: document.getElementById("gabarito").checked,
    versoes: 1,
    dist_niveis: document.getElementById("dist_niveis").value.trim(),
    usar_apostila: document.getElementById("usar_apostila").checked,
    ia: document.getElementById("ia").value
  };

  const formData = new FormData();
  formData.append("dados", JSON.stringify(payload));
  const arquivo = document.getElementById("apostila").files[0];
  if(arquivo){
    formData.append("apostila", arquivo);
  }

  try{
    const resp = await fetch("https://masayoshi.app.n8n.cloud/webhook/gerar-prova",{
      method:"POST",
      body:formData
    });
    const data = await resp.json();

    if(!data.html_prova){
      resultado.innerHTML = "Erro: resposta sem html_prova.";
      return;
    }

    resultado.innerHTML =
      `<strong>Título:</strong> ${data.titulo || ""}<br>` +
      `<strong>Curso:</strong> ${data.curso || ""}<br>` +
      `<strong>Questões:</strong> ${data.questoes?.length || 0}`;

    // guarda HTML cru para exportação
    provaHtmlDiv.innerHTML = data.html_prova;

    // Exibe no iframe com fundo branco
    iframe.srcdoc =
      `<style>
        body { background:#ffffff !important; color:#000000 !important; font-family:Arial,sans-serif !important; }
        * { color:#000000 !important; }
      </style>` +
      data.html_prova;

    iframe.style.display = "block";
    provaContainer.style.display = "block";
  }catch(e){
    resultado.innerHTML = "Erro ao gerar prova: " + e.message;
  }finally{
    botao.classList.remove("is-loading");
    botao.innerHTML = textoOriginal;
  }
}

function baixarPDF(){
  const element = document.getElementById("prova-html");
  if(!element || !element.innerHTML.trim()){
    alert("Nenhuma prova gerada ainda.");
    return;
  }

  // Clona o conteúdo em um container visível e simples
  const temp = document.createElement("div");
  temp.style.background = "#ffffff";
  temp.style.color = "#000000";
  temp.style.padding = "20px";
  temp.style.fontFamily = "Arial, sans-serif";
  temp.style.fontSize = "12pt";
  temp.innerHTML = element.innerHTML;
  document.body.appendChild(temp);

  const opt = {
    margin: 10,
    filename: 'prova-masayoshi.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  // Usa o modo async para poder limpar depois
  html2pdf().set(opt).from(temp).save().then(() => {
    document.body.removeChild(temp);
  }).catch(() => {
    document.body.removeChild(temp);
  });
}

function baixarWord(){
  const element = document.getElementById("prova-html");
  if(!element || !element.innerHTML.trim()){
    alert("Nenhuma prova gerada ainda.");
    return;
  }
  if (!window.htmlDocx || !window.htmlDocx.asBlob) {
    alert("Biblioteca de Word não carregou.");
    return;
  }
  const html =
    '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Prova Masayoshi</title>' +
    '<style>body{font-family:Arial,sans-serif;font-size:12pt;}</style></head><body>' +
    element.innerHTML +
    '</body></html>';
  const blob = window.htmlDocx.asBlob(html);
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'prova-masayoshi.docx';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
